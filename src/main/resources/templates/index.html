<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" data-bs-theme="dark">
<head>
    <title>AI2MQTT Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-PENDING { background-color: #ffc107; color: #000; }
        .status-COMPLETED { background-color: #198754; color: #fff; }
        .status-FAILED { background-color: #dc3545; color: #fff; }
        .pre-wrap { white-space: pre-wrap; }
        body { transition: background-color 0.3s, color 0.3s; }
        .card, .accordion-item { transition: background-color 0.3s, border-color 0.3s; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-5 fw-bold">AI2MQTT</h1>
            <p class="text-muted mb-0">Hotswappable Bridge: OpenAI / ActiveMQ / MQTT</p>
        </div>
        <button id="themeToggle" class="btn btn-outline-secondary fs-4 border-0" onclick="toggleTheme()">‚òÄÔ∏è</button>
    </div>

    <div class="card shadow-sm mb-5">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Send New Prompt</h5>
        </div>
        <div class="card-body">
            <form action="/send" method="post">
                <div class="row g-3">

                    <div class="col-md-3">
                        <label for="threadIdInput" class="form-label fw-bold">Thread ID</label>
                        <input type="text" class="form-control" id="threadIdInput" name="threadId" placeholder="New Chat">
                    </div>
                    <div class="col-md-9">
                        <label for="promptInput" class="form-label fw-bold">Prompt</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="promptInput" name="prompt" required placeholder="Ask the AI something...">
                            <button type="submit" class="btn btn-success fw-bold">Send</button>
                        </div>
                    </div>

                    <div class="col-12">
                        <a class="text-decoration-none small text-muted" data-bs-toggle="collapse" href="#advancedOptions" role="button" aria-expanded="false" aria-controls="advancedOptions">
                            ‚öôÔ∏è Advanced Options (System Persona)
                        </a>
                        <div class="collapse mt-2" id="advancedOptions">
                            <div class="card card-body bg-body-tertiary">
                                <label for="systemPrompt" class="form-label fw-bold">System Persona Override</label>
                                <input type="text" class="form-control" id="systemPrompt" name="systemPrompt"
                                       placeholder="e.g., 'You are a sarcastic pirate.' (Leave blank for default)">
                                <div class="form-text">If set, this replaces the default behavior defined in application.properties.</div>
                            </div>
                        </div>
                    </div>

                </div>
            </form>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Conversation History</h4>
        <a href="/" class="btn btn-sm btn-outline-secondary">Refresh</a>
    </div>

    <div th:if="${groupedChats.empty}" class="alert alert-info text-center">
        No history found. Send a prompt above to get started!
    </div>

    <div class="accordion" id="chatAccordion" th:unless="${groupedChats.empty}">
        <div class="accordion-item" th:each="entry, stats : ${groupedChats}">
            <h2 class="accordion-header" th:id="'heading' + ${stats.index}">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse"
                        th:data-bs-target="'#collapse' + ${stats.index}"
                        aria-expanded="false"
                        th:aria-controls="'collapse' + ${stats.index}">
                    <div class="d-flex w-100 justify-content-between me-3">
                        <span>
                            <strong>Thread:</strong> <span th:text="${entry.key}" class="font-monospace">uuid</span>
                        </span>
                        <span class="badge bg-secondary rounded-pill" th:text="${entry.value.size()} + ' msgs'">0 msgs</span>
                    </div>
                </button>
            </h2>

            <div th:id="'collapse' + ${stats.index}" class="accordion-collapse collapse"
                 th:aria-labelledby="'heading' + ${stats.index}"
                 data-bs-parent="#chatAccordion">
                <div class="accordion-body">

                    <div class="mb-3 text-end border-bottom pb-2">
                        <button class="btn btn-sm btn-outline-primary"
                                onclick="fillThreadId(this.getAttribute('data-id'))"
                                th:data-id="${entry.key}">
                            Reply to this Context
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                            <tr>
                                <th style="width: 35%">User Prompt</th>
                                <th style="width: 45%">AI Response</th>
                                <th style="width: 10%">Status</th>
                                <th style="width: 10%">Time</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="msg : ${entry.value}">
                                <td class="text-break" th:text="${msg.prompt}">Prompt</td>
                                <td class="text-break pre-wrap font-monospace small" th:text="${msg.response}">Response</td>
                                <td>
                                        <span class="badge"
                                              th:classappend="'status-' + ${msg.status}"
                                              th:text="${msg.status}">STATUS</span>
                                </td>
                                <td th:text="${#temporals.format(msg.timestamp, 'HH:mm:ss')}">12:00</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center text-muted mt-5 mb-3">
        <small>AI2MQTT &copy; 2025 Azzie Development</small>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function fillThreadId(uuid) {
        document.getElementById('threadIdInput').value = uuid;
        document.getElementById('promptInput').focus();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    const htmlElement = document.documentElement;
    const toggleBtn = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'dark';
    setTheme(savedTheme);

    function toggleTheme() {
        const currentTheme = htmlElement.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        setTheme(newTheme);
    }

    function setTheme(theme) {
        htmlElement.setAttribute('data-bs-theme', theme);
        localStorage.setItem('theme', theme);
        toggleBtn.innerText = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
</script>
</body>
</html>